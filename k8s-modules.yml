#
# cloud-commons-parent
k8s-package:cloud-commons-parent:
  variables:
    MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
    MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"
  stage: k8s-package
  image: maven:3.6.3-jdk-8
  script:
    # 26649 是 https://jihulab.com/xuxiaowei-cloud/xuxiaowei-cloud 的项目ID
    # 修改为 极狐GitLab Maven 仓库
    - mvn clean -e -U -am -pl cloud-commons-parent,cloud-commons-parent/cloud-starter-core,cloud-commons-parent/cloud-starter-idempotent,cloud-commons-parent/cloud-starter-loadbalancer,cloud-commons-parent/cloud-starter-log,cloud-commons-parent/cloud-starter-mybatis,cloud-commons-parent/cloud-starter-oauth2,cloud-commons-parent/cloud-starter-openfeign,cloud-commons-parent/cloud-starter-redis,cloud-commons-parent/cloud-starter-session-redis,cloud-commons-parent/cloud-starter-system,cloud-commons-parent/cloud-starter-validation package source:jar javadoc:jar deploy -Pgitlab-maven -DskipTests -s settings-jihulab.xml && PACKAGE_FLAG=1;
    - if [ "$PACKAGE_FLAG" == "1" ]; then echo '发布组件完成'; else echo '发布组件失败' && xxxx; fi
    - rm -rf .m2/repository/cloud/xuxiaowei
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .m2/repository
      - passport-ui/node/
      - passport-ui/node_modules/
      - ui/node/
      - ui/node_modules/
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "k8s-modules/cloud-commons-parent"
    - if: $CI_COMMIT_BRANCH == "k8s-modules/cloud-commons-parent"
  tags:
    - jihulab

#
# passport
k8s-package:passport:
  variables:
    MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
    MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"
  stage: k8s-package
  image: maven:3.6.3-jdk-8
  script:
    - mvn clean -e -U -pl passport-ui,passport package install -Pgitlab-maven -DskipTests -s settings-jihulab.xml && PACKAGE_FLAG=1;
    - if [ "$PACKAGE_FLAG" == "1" ]; then echo '打包完成'; else echo '打包失败' && xxxx; fi
    - mvn -pl passport -Pgitlab-maven -s settings-jihulab.xml docker:build -DCI_PIPELINE_ID=$CI_PIPELINE_ID;
    - mvn -pl passport -Pgitlab-maven -s settings-jihulab.xml docker:push;
    - rm -rf .m2/repository/cloud/xuxiaowei
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .m2/repository
      - passport-ui/node/
      - passport-ui/node_modules/
      - ui/node/
      - ui/node_modules/
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "k8s-modules/passport"
    - if: $CI_COMMIT_BRANCH == "k8s-modules/passport"
  tags:
    # 个人服务器 Runner 标签（仅在个人服务器上执行）
    - plugin-kubernetes

#
# 使用 shell 发布 k8s
# 在 k8s 所在的服务器上执行
k8s-publish:passport:
  stage: k8s-publish
  needs:
    - job: k8s-package:passport
  script:
    - kubectl -n xuxiaowei-cloud get deployment passport-deployment || kubectl create -f passport/passport-deployment.yaml
    - kubectl -n xuxiaowei-cloud set image deployment/passport-deployment passport=registry.docker.example.xuxiaowei.cloud/cloud.xuxiaowei/passport:0.0.1-SNAPSHOT-$CI_PIPELINE_ID
  # https://docs.gitlab.com/ee/ci/yaml/index.html#rules
  # 极狐GitLab中文文档：https://docs.gitlab.cn/jh/ci/yaml/index.html#rules
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "k8s-modules/passport"
    - if: $CI_COMMIT_BRANCH == "k8s-modules/passport"
  tags:
    # 仅在 tags 名称为 shell 的执行器上执行
    # 在 k8s 所在的服务器上执行
    # 个人服务器 Runner 标签（仅在个人服务器上执行）
    - k8s-publish

#
# 等待/检查滚动发布
k8s-waiting-rollout:passport:
  stage: k8s-waiting-rollout
  needs:
    - job: k8s-publish:passport
  script:
    # 查看滚动发布的状态，如果滚动发布未就绪，命令会等待
    - kubectl -n xuxiaowei-cloud rollout status deployment/passport-deployment
  # 超时时间，根据程序启动时间调整
  timeout: 600s
  # https://docs.gitlab.com/ee/ci/yaml/index.html#rules
  # 极狐GitLab中文文档：https://docs.gitlab.cn/jh/ci/yaml/index.html#rules
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "k8s-modules/passport"
    - if: $CI_COMMIT_BRANCH == "k8s-modules/passport"
  tags:
    # 仅在 tags 名称为 shell 的执行器上执行
    # 在 k8s 所在的服务器上执行
    # 个人服务器 Runner 标签（仅在个人服务器上执行）
    - k8s-publish
